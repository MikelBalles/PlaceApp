DROP DATABASE IF EXISTS PROYECTO_PLACEAPP_UNIR_2024;
CREATE DATABASE PROYECTO_PLACEAPP_UNIR_2024;
USE PROYECTO_PLACEAPP_UNIR_2024;

CREATE TABLE TIPOS
(ID_TIPO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(45) NOT NULL,
DESCRIPCION VARCHAR(200)
);

CREATE TABLE SUBTIPOS
(ID_SUBTIPO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(45) NOT NULL,
ID_TIPO INT NOT NULL,
FOREIGN KEY(ID_TIPO) REFERENCES TIPOS(ID_TIPO)
);

CREATE TABLE PROVINCIAS
(ID_PROV INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(45) NOT NULL
);

CREATE TABLE EXTRAS
(ID_EXTRA INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(45) NOT NULL,
DESCRIPCION VARCHAR(200),
PRECIO DEC(9,2)
);


CREATE TABLE ESPACIOS
(ID_ESPACIO INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(50) NOT NULL,
DESCRIPCION VARCHAR(200),
DIRECCION VARCHAR(100),
CP INT, /*Codigo postal*/
ENABLED INT,
PRECIO DEC(9,2),
ID_SUBTIPO INT NOT NULL,
FOREIGN KEY(ID_SUBTIPO) REFERENCES SUBTIPOS(ID_SUBTIPO),
ID_PROV INT NOT NULL,
FOREIGN KEY(ID_PROV) REFERENCES PROVINCIAS(ID_PROV)
);

CREATE TABLE EXTRAS_ESPACIOS
(ID_EXTRA INT NOT NULL,
ID_ESPACIO INT NOT NULL,
PRIMARY KEY(ID_EXTRA, ID_ESPACIO),
FOREIGN KEY(ID_EXTRA) REFERENCES EXTRAS(ID_EXTRA),
FOREIGN KEY(ID_ESPACIO) REFERENCES ESPACIOS(ID_ESPACIO)
);

CREATE TABLE USUARIOS
(
USERNAME VARCHAR(45) NOT NULL PRIMARY KEY,
PASSWORD VARCHAR(200) NOT NULL,
NOMBRE VARCHAR(50),
APELLIDOS VARCHAR(50),
DIRECCION VARCHAR(100),
TELEFONO INT,
ENABLED INT NOT NULL DEFAULT 1,
FECHA_REGISTRO DATE,
ID_PROV INT NOT NULL,
FOREIGN KEY(ID_PROV) REFERENCES PROVINCIAS(ID_PROV)
);
/*
INSERT INTO `usuarios` (`USERNAME`,`PASSWORD`,`NOMBRE`,`apellidos`,`DIRECCION`,`ENABLED`,`FECHA_REGISTRO`) VALUES ('mikel@fp.com','{noop}mikel','mikel','ballesteros','calle rosa 22, madrid',1,'2021-06-01');
INSERT INTO `usuarios` (`USERNAME`,`PASSWORD`,`NOMBRE`,`apellidos`,`DIRECCION`,`ENABLED`,`FECHA_REGISTRO`) VALUES ('alejandro@fp.com','{noop}alejandro','alejandro','paris','calle jazmin 20, madrid',1,'2021-02-01');
INSERT INTO `usuarios` (`USERNAME`,`PASSWORD`,`NOMBRE`,`apellidos`,`DIRECCION`,`ENABLED`,`FECHA_REGISTRO`) VALUES ('tomas@fp.com','{noop}tomasin','tomas','escudero','calle alamin 30, madrid',1,'2021-01-01');
*/
CREATE TABLE USUARIO_ESPACIOS
(USERNAME VARCHAR(45) NOT NULL,
ID_ESPACIO INT NOT NULL,
PRIMARY KEY(USERNAME, ID_ESPACIO),
FOREIGN KEY(USERNAME) REFERENCES USUARIOS(USERNAME),
FOREIGN KEY(ID_ESPACIO) REFERENCES ESPACIOS(ID_ESPACIO)
);


CREATE TABLE RESERVAS
(ID_RESERVA INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
ID_ESPACIO INT NOT NULL,
USERNAME VARCHAR(45) NOT NULL,
PRECIO_VENTA DEC(9,2),
FECHA_INICIO DATETIME,
FECHA_FIN DATETIME,
ENABLED INT NOT NULL DEFAULT 1,
OBSERVACIONES VARCHAR(200),
FOREIGN KEY(USERNAME) REFERENCES USUARIOS(USERNAME),
FOREIGN KEY(ID_ESPACIO) REFERENCES ESPACIOS(ID_ESPACIO)
);

-- TABLAS PARA LOGIN, LOGOUT y REGISTRO o  SPRING SECURITY 

CREATE TABLE PERFILES
(ID_PERFIL INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOMBRE VARCHAR(45) NOT NULL
);
/*
INSERT INTO `perfiles` (`ID_PERFIL`,`NOMBRE`) VALUES (1,'ROLE_ADMINISTRADOR');
INSERT INTO `perfiles` (`ID_PERFIL`,`NOMBRE`) VALUES (2,'ROLE_PROPIETARIO');
INSERT INTO `perfiles` (`ID_PERFIL`,`NOMBRE`) VALUES (3,'ROLE_CLIENTE');
*/
CREATE TABLE USUARIO_PERFILES
(USERNAME VARCHAR(45) NOT NULL,
ID_PERFIL INT NOT NULL,
PRIMARY KEY(USERNAME, ID_PERFIL),
FOREIGN KEY(USERNAME) REFERENCES USUARIOS(USERNAME),
FOREIGN KEY(ID_PERFIL) REFERENCES PERFILES(ID_PERFIL)
);
/*
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('mikel@fp.com',1);
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('alejandro@fp.com',1);
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('mikel@fp.com',2);
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('alejandro@fp.com',2);
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('mikel@fp.com',3);
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('alejandro@fp.com',3);
INSERT INTO `usuario_perfiles` (`USERNAME`,`ID_PERFIL`) VALUES ('tomas@fp.com',3);
-- creacion de usuarios para aislarlo del root
*/
create user proyecto_unir identified by 'proyecto';
grant all privileges on PROYECTO_PLACEAPP_UNIR_2024.* to proyecto_unir;
